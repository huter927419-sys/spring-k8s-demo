# ============================================================================
# Spring Boot Application Deployment
# Spring Boot 应用程序部署配置
# ============================================================================
# 
# This deployment configures the Spring Boot backend application with:
# - 3 replicas for high availability
# - Security context for non-root execution
# - Environment variables from Kubernetes Secrets and ConfigMaps
# - Health probes for liveness and readiness
# - Resource limits and requests
# - Horizontal Pod Autoscaler support
#
# 该部署配置 Spring Boot 后端应用程序，包括：
# - 3 个副本以实现高可用性
# - 非 root 执行的安全上下文
# - 来自 Kubernetes Secrets 和 ConfigMaps 的环境变量
# - 用于存活性就绪性的健康探针
# - 资源限制和请求
# - 水平 Pod 自动扩缩容支持
#
# ============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: spring-k8s-demo
  labels:
    app: spring-k8s-demo
spec:
  # Number of replicas / 副本数量
  replicas: 3
  selector:
    matchLabels:
      app: spring-k8s-demo
  template:
    metadata:
      labels:
        app: spring-k8s-demo
    spec:
      # Pod Security Context - Run as non-root user
      # Pod 安全上下文 - 以非 root 用户运行
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: spring-k8s-demo
        # Container image / 容器镜像
        # Use GraalVM Native Image for ultra-fast startup (1-3 seconds vs 60+ seconds)
        # 使用 GraalVM Native Image 实现超快启动（1-3 秒 vs 60+ 秒）
        image: spring-k8s-demo-native:1.0.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: http
        # Container Security Context / 容器安全上下文
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities:
            drop:
            - ALL
        # Environment Variables / 环境变量
        env:
        - name: SPRING_APPLICATION_NAME
          value: "spring-k8s-demo"
        - name: DB_HOST
          value: "mysql-service"
        - name: DB_PORT
          value: "3306"
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: MYSQL_DATABASE
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: MYSQL_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: MYSQL_PASSWORD
        - name: REDIS_HOST
          value: "redis-service"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redis-secret
              key: REDIS_PASSWORD
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: jwt-secret
              key: JWT_SECRET
        - name: JWT_EXPIRATION
          value: "86400000"  # 24 hours in milliseconds / 24 小时（毫秒）
        # JVM Optimization Parameters for Faster Startup
        # JVM 优化参数以加快启动速度
        - name: JAVA_OPTS
          value: "-XX:+UseG1GC -XX:MaxRAMPercentage=75.0 -XX:InitialRAMPercentage=50.0 -XX:+UseContainerSupport -Djava.security.egd=file:/dev/./urandom -Dspring.jmx.enabled=false -Dspring.backgroundpreinitializer.ignore=true"
        # Spring Boot Optimization / Spring Boot 优化
        - name: SPRING_JPA_SHOW_SQL
          value: "false"
        - name: SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL
          value: "false"
        # Liveness Probe - Check if container is alive
        # 存活性探针 - 检查容器是否存活
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60  # Wait 1 minute before first check (reduced from 120) / 首次检查前等待 1 分钟（从 120 减少）
          periodSeconds: 30        # Check every 30 seconds / 每 30 秒检查一次
          timeoutSeconds: 5
          failureThreshold: 3       # Restart after 3 failures / 3 次失败后重启
          successThreshold: 1
        # Readiness Probe - Check if container is ready to serve traffic
        # 就绪性探针 - 检查容器是否准备好处理流量
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30  # Wait 30 seconds before first check (reduced from 60) / 首次检查前等待 30 秒（从 60 减少）
          periodSeconds: 10        # Check every 10 seconds / 每 10 秒检查一次
          timeoutSeconds: 3
          failureThreshold: 3       # Mark as not ready after 3 failures / 3 次失败后标记为未就绪
          successThreshold: 1
        # Startup Probe - Optimized for faster detection
        # 启动探针 - 优化以更快检测
        startupProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 10  # Start checking after 10 seconds / 10 秒后开始检查
          periodSeconds: 5         # Check every 5 seconds / 每 5 秒检查一次
          timeoutSeconds: 3
          failureThreshold: 24     # Allow up to 120 seconds (2 minutes) for startup
                                   # 允许最多 120 秒（2 分钟）启动时间
        # Resource Limits and Requests - Optimized for faster startup
        # 资源限制和请求 - 优化以加快启动
        resources:
          requests:
            memory: "512Mi"  # Minimum memory required / 所需最小内存
            cpu: "500m"      # Increased CPU for faster startup / 增加 CPU 以加快启动
          limits:
            memory: "1Gi"   # Maximum memory allowed / 允许的最大内存
            cpu: "1000m"    # Maximum CPU allowed / 允许的最大 CPU

